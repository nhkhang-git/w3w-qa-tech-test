const report = require("multiple-cucumber-html-reporter");
const fs = require("fs");
const path = require("path");

// Ensure reports directory exists
const reportsDir = "cypress/reports";
if (!fs.existsSync(reportsDir)) {
  fs.mkdirSync(reportsDir, { recursive: true });
}

const htmlReportsDir = path.join(reportsDir, "html");
if (!fs.existsSync(htmlReportsDir)) {
  fs.mkdirSync(htmlReportsDir, { recursive: true });
}

// Function to get all JSON files from cucumber-json directory
function getJsonReports() {
  const jsonDir = path.join(reportsDir, "cucumber-json");

  if (!fs.existsSync(jsonDir)) {
    console.log("‚ö†Ô∏è No cucumber-json directory found. No reports to generate.");
    return [];
  }

  return fs
    .readdirSync(jsonDir)
    .filter((file) => file.endsWith(".json"))
    .map((file) => path.join(jsonDir, file));
}

// Generate HTML report from JSON files
function generateHTMLReport() {
  const jsonFiles = getJsonReports();

  if (jsonFiles.length === 0) {
    console.log("‚ö†Ô∏è No JSON report files found. Skipping HTML report generation.");
    return;
  }

  console.log(`üìä Found ${jsonFiles.length} JSON report file(s). Generating HTML report...`);

  report.generate({
    jsonDir: path.join(reportsDir, "cucumber-json"),
    reportPath: htmlReportsDir,
    displayDuration: true,
    durationInMS: true,
    displayReportTime: true,
    openReportInBrowser: false,
    saveCollectedJSON: true,
    reportName: "W3W Cypress Test Report",
    pageTitle: "W3W QA Tech Test Results",
    pageFooter: "<div><p>Generated by W3W QA Automation Framework</p></div>",
    customData: {
      title: "Test Execution Info",
      data: [
        { label: "Project", value: "W3W QA Tech Test" },
        { label: "Framework", value: "Cypress + Cucumber" },
        { label: "Environment", value: process.env.NODE_ENV || "test" },
        { label: "Execution Time", value: new Date().toLocaleString() },
        { label: "CI/CD", value: process.env.CIRCLECI ? "CircleCI" : "Local" },
      ],
    },
  });

  console.log("‚úÖ HTML report generated successfully!");
  console.log(`üìÇ Report location: ${path.resolve(htmlReportsDir)}`);

  // Log report file for CircleCI artifacts
  const reportFile = path.join(htmlReportsDir, "index.html");
  if (fs.existsSync(reportFile)) {
    console.log(`üåê Main report file: ${reportFile}`);
  }
}

// Function to create summary JSON for CircleCI
function generateSummaryJSON() {
  const jsonFiles = getJsonReports();

  if (jsonFiles.length === 0) {
    return;
  }

  let totalScenarios = 0;
  let passedScenarios = 0;
  let failedScenarios = 0;
  let totalFeatures = 0;
  const tagSummary = {};

  jsonFiles.forEach((jsonFile) => {
    try {
      const data = JSON.parse(fs.readFileSync(jsonFile, "utf8"));

      data.forEach((feature) => {
        totalFeatures++;

        feature.elements?.forEach((scenario) => {
          if (scenario.type === "scenario") {
            totalScenarios++;

            const isPassed = scenario.steps?.every(
              (step) => step.result?.status === "passed" || step.result?.status === "skipped"
            );

            if (isPassed) {
              passedScenarios++;
            } else {
              failedScenarios++;
            }

            // Count tags
            scenario.tags?.forEach((tag) => {
              const tagName = tag.name;
              if (!tagSummary[tagName]) {
                tagSummary[tagName] = { total: 0, passed: 0, failed: 0 };
              }
              tagSummary[tagName].total++;
              if (isPassed) {
                tagSummary[tagName].passed++;
              } else {
                tagSummary[tagName].failed++;
              }
            });
          }
        });
      });
    } catch (error) {
      console.error(`Error processing ${jsonFile}:`, error.message);
    }
  });

  const summary = {
    executionTime: new Date().toISOString(),
    environment: process.env.NODE_ENV || "test",
    cicd: process.env.CIRCLECI ? "CircleCI" : "Local",
    totalFeatures,
    totalScenarios,
    passedScenarios,
    failedScenarios,
    passRate: totalScenarios > 0 ? Math.round((passedScenarios / totalScenarios) * 100) : 0,
    tagSummary,
  };

  const summaryFile = path.join(reportsDir, "test-summary.json");
  fs.writeFileSync(summaryFile, JSON.stringify(summary, null, 2));

  console.log("üìã Test Summary:");
  console.log(`   Features: ${totalFeatures}`);
  console.log(`   Scenarios: ${passedScenarios}/${totalScenarios} passed (${summary.passRate}%)`);
  console.log(`   Tags: ${Object.keys(tagSummary).join(", ")}`);
  console.log(`üìÑ Summary saved to: ${summaryFile}`);
}

// Main execution
try {
  console.log("üöÄ Starting report generation...");
  generateHTMLReport();
  generateSummaryJSON();
  console.log("‚úÖ Report generation completed successfully!");
} catch (error) {
  console.error("‚ùå Report generation failed:", error.message);
  process.exit(1);
}
